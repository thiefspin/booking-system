<div class="container container-main">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Lookup Form Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Manage Your Appointment</h4>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">
            Enter your email address and booking reference to view or cancel
            your appointment.
          </p>

          <!-- Success Message -->
          <div class="alert alert-success" *ngIf="successMessage">
            <i class="bi bi-check-circle-fill me-2"></i>
            {{ successMessage }}
          </div>

          <!-- Error Message -->
          <div class="alert alert-danger" *ngIf="error">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ error }}
          </div>

          <!-- Lookup Form -->
          <form [formGroup]="lookupForm" (ngSubmit)="lookupAppointment()">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="email" class="form-label">Email Address *</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    formControlName="email"
                    placeholder="your.email@example.com"
                    (blur)="markFieldAsTouched('email')"
                    [class.is-invalid]="
                      lookupForm.get('email')?.invalid &&
                      lookupForm.get('email')?.touched
                    "
                  />
                  <div
                    class="text-danger small mt-1"
                    *ngIf="
                      lookupForm.get('email')?.invalid &&
                      lookupForm.get('email')?.touched
                    "
                  >
                    Please enter a valid email address.
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="bookingReference" class="form-label"
                    >Booking Reference *</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="bookingReference"
                    formControlName="bookingReference"
                    placeholder="e.g., BK12345678"
                    (blur)="markFieldAsTouched('bookingReference')"
                    [class.is-invalid]="
                      lookupForm.get('bookingReference')?.invalid &&
                      lookupForm.get('bookingReference')?.touched
                    "
                  />
                  <div
                    class="text-danger small mt-1"
                    *ngIf="
                      lookupForm.get('bookingReference')?.invalid &&
                      lookupForm.get('bookingReference')?.touched
                    "
                  >
                    Booking reference is required.
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="!lookupForm.valid || loading"
              >
                <span *ngIf="!loading">
                  <i class="bi bi-search me-2"></i> Look Up Appointment
                </span>
                <span *ngIf="loading">
                  <span
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  ></span>
                  Looking up...
                </span>
              </button>
              <button type="button" class="btn btn-link" routerLink="/book">
                Book New Appointment
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Appointment Details Card -->
      <div class="card" *ngIf="appointment">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Appointment Details</h5>
          <span class="badge bg-{{ getStatusColor(appointment.status) }}">
            {{ appointment.status }}
          </span>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="text-muted">Booking Reference</h6>
              <p class="fw-bold fs-5 font-monospace">
                {{ appointment.bookingReference }}
              </p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Status</h6>
              <p>
                <span
                  class="badge bg-{{ getStatusColor(appointment.status) }} fs-6"
                >
                  {{ appointment.status }}
                </span>
              </p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="text-muted">Customer Name</h6>
              <p>
                {{ appointment.customerFirstName }}
                {{ appointment.customerLastName }}
              </p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Contact Information</h6>
              <p>
                <i class="bi bi-envelope me-2"></i>{{ appointment.customerEmail
                }}<br />
                <i class="bi bi-telephone me-2"></i
                >{{ appointment.customerPhone }}
              </p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="text-muted">Appointment Date & Time</h6>
              <p class="fw-semibold">
                {{ formatDateTime(appointment.appointmentDateTime) }}
              </p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Duration</h6>
              <p>{{ appointment.durationMinutes }} minutes</p>
            </div>
          </div>

          <div class="row mb-3" *ngIf="appointment.purpose">
            <div class="col-12">
              <h6 class="text-muted">Purpose</h6>
              <p>{{ appointment.purpose }}</p>
            </div>
          </div>

          <div class="row mb-3" *ngIf="appointment.notes">
            <div class="col-12">
              <h6 class="text-muted">Notes</h6>
              <p>{{ appointment.notes }}</p>
            </div>
          </div>

          <hr />

          <div class="d-flex justify-content-between align-items-center">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="resetForm()"
            >
              <i class="bi bi-arrow-left me-2"></i> Look Up Another
            </button>
            <button
              type="button"
              class="btn btn-danger"
              *ngIf="canCancelAppointment()"
              (click)="showCancelConfirmation()"
            >
              <i class="bi bi-x-circle me-2"></i> Cancel Appointment
            </button>
            <div
              *ngIf="
                !canCancelAppointment() && appointment.status === 'CANCELLED'
              "
            >
              <span class="text-danger">
                <i class="bi bi-info-circle me-2"></i>
                This appointment has already been cancelled.
              </span>
            </div>
            <div
              *ngIf="
                !canCancelAppointment() && appointment.status === 'COMPLETED'
              "
            >
              <span class="text-secondary">
                <i class="bi bi-check-circle me-2"></i>
                This appointment has been completed.
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Confirmation Modal -->
  <div
    class="modal"
    [class.show]="showCancelDialog"
    [style.display]="showCancelDialog ? 'block' : 'none'"
    tabindex="-1"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Cancel Appointment</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            (click)="closeCancelDialog()"
          ></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Are you sure you want to cancel this appointment? This action cannot
            be undone.
          </div>

          <div class="mb-3" *ngIf="appointment">
            <p>
              <strong>Booking Reference:</strong>
              {{ appointment.bookingReference }}
            </p>
            <p>
              <strong>Date & Time:</strong>
              {{ formatDateTime(appointment.appointmentDateTime) }}
            </p>
          </div>

          <form [formGroup]="cancelForm">
            <div class="mb-3">
              <label for="reason" class="form-label"
                >Cancellation Reason (Optional)</label
              >
              <textarea
                class="form-control"
                id="reason"
                formControlName="reason"
                rows="3"
                placeholder="Please let us know why you're cancelling..."
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeCancelDialog()"
            [disabled]="loading"
          >
            Keep Appointment
          </button>
          <button
            type="button"
            class="btn btn-danger"
            (click)="cancelAppointment()"
            [disabled]="loading"
          >
            <span *ngIf="!loading">
              <i class="bi bi-x-circle me-2"></i> Yes, Cancel Appointment
            </span>
            <span *ngIf="loading">
              <span
                class="spinner-border spinner-border-sm me-2"
                role="status"
              ></span>
              Cancelling...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop show" *ngIf="showCancelDialog"></div>
</div>
